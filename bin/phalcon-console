#!/usr/bin/env php
<?php

use Phalcon\Console\Color;
use Phalcon\Console\Console;
use Phalcon\Console\Location;

$baseDir = dirname(__DIR__);
if (str_ends_with($baseDir, 'phalcon-console') === true) {
    // We expect to be in vendor/noone-silent/phalcon-console
    $baseDir = dirname($baseDir, 3);
}

require_once $baseDir . '/vendor/autoload.php';

$composerJson = file_get_contents($baseDir . '/composer.json');
if ($composerJson === false) {
    echo 'Could not parse composer.json', PHP_EOL;
    exit(1);
}
try {
    $composer = json_decode($composerJson, true, 512, JSON_THROW_ON_ERROR);
} catch (Throwable $exc) {
    echo 'Could not parse composer.json to json: ', $exc->getMessage(), PHP_EOL;
    exit(1);
}

$settings = $composer['extra']['phalcon-console'] ?? [];

$locations = [];
foreach ($settings['locations'] ?? [] as $location) {
    $locations[] = new Location($baseDir . DIRECTORY_SEPARATOR . $location);
}

if (isset($settings['bootstrap']) === true) {
    $settings['bootstrap'] = $baseDir . DIRECTORY_SEPARATOR . $settings['bootstrap'];
}

$console = new Console($locations, $settings);
if (($settings['colored'] ?? true) === true) {
    $console->setColor(new Color());
}

$console->run($argv ?? []);